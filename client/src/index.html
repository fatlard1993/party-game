<html>
	<script type="text/javascript">
		var Loaded = false;

		function Load(){
			if(Loaded) return;
			Loaded = true;

			const ws = new WebSocket('ws://'+ location.host +'/api');
			const gameStatus = document.getElementById('status');
			const gameButton = document.getElementById('action');
			var game = {};

			ws.json = function(data){
				ws.send(JSON.stringify(data));
			};

			ws.addEventListener('open', function(evt){
				console.log('Websocket connection open: ', evt);

				gameStatus.textContent += '.';

				ws.json({ type: 'knock', user: { id: localStorage.id } });
			});

			ws.addEventListener('message', function(evt){
				console.log('Message from server: ', evt.data);

				var data = JSON.parse(evt.data);

				if(data.type === 'welcome'){
					gameStatus.textContent = 'READY';
					gameButton.textContent = 'Start';

					localStorage.id = data.user.id;
					game = data.game;
				}

				else if(data.type === 'gameState'){
					game = Object.assign(game, data.state);

					console.log(game);
				}
			});

			function onPointerUp(evt){
				console.log('onPointerUp', evt);

				if(evt.target.id === 'action'){
					ws.json({ type: 'updateState', state: { screen: { width: window.innerWidth, height: window.innerHeight } } });
				}
			}

			document.addEventListener('click', onPointerUp);
			document.addEventListener('touchend', onPointerUp);
		}

		document.addEventListener('DOMContentLoaded', Load);
	</script>
	<body>
		<div id="status">Loading.</div>
		<button id="action"></button>
	</body>
</html>